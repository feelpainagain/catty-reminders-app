name: CD

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to VM via SSH (run Docker container)
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: course.prafdin.ru
          port: ${{ secrets.SSH_PORT }}
          username: Ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          debug: true
          script: |
            set -e

            LOG_FILE=/home/Ubuntu/deploy.log

            echo "Logging into GitHub Container Registry from VM..." | tee -a "$LOG_FILE"
            echo "${TOKEN}" | sudo docker login ghcr.io -u "feelpainagain" --password-stdin >> "$LOG_FILE" 2>&1

            echo "Pulling latest image..." | tee -a "$LOG_FILE"
            sudo docker pull ghcr.io/feelpainagain/catty-reminders-app:latest >> "$LOG_FILE" 2>&1

            echo "Stopping old container if exists..." | tee -a "$LOG_FILE"
            sudo docker rm -f catty-reminders-app || true

            echo "Starting new container..." | tee -a "$LOG_FILE"
            sudo docker run -d \
              --name catty-reminders-app \
              -p 8181:8181 \
              ghcr.io/feelpainagain/catty-reminders-app:latest >> "$LOG_FILE" 2>&1

            echo "Waiting for app to start..." | tee -a "$LOG_FILE"
            sleep 5

            echo "Checking app health..." | tee -a "$LOG_FILE"
            curl -s http://127.0.0.1:8181/docs > /dev/null

            echo "Deployment via Docker container finished successfully." | tee -a "$LOG_FILE"
        env:
          TOKEN: ${{ secrets.TOKEN }}
