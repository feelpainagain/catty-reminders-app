name: CD

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Дебаг: смотрим, что за ключ реально приходит в раннер
      - name: Debug SSH private key
        run: |
          echo "Key length: ${#SSH_PRIVATE_KEY}"
          echo "-----BEGIN (first lines)-----"
          echo "${SSH_PRIVATE_KEY}" | head -n 3
          echo "-----END (last lines)-----"
          echo "${SSH_PRIVATE_KEY}" | tail -n 3
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to VM via SSH (run Docker container)
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: course.prafdin.ru
          port: ${{ secrets.SSH_PORT }}
          username: Ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          debug: true
          script: |
            set -e

            echo "Stopping old systemd service (if running)..."
            sudo systemctl stop myapp || true

            echo "Logging into GitHub Container Registry from VM..."
            echo "${GITHUB_TOKEN}" | docker login ghcr.io -u "${GITHUB_ACTOR}" --password-stdin

            echo "Pulling latest image..."
            docker pull ghcr.io/${GITHUB_REPOSITORY_OWNER}/catty-reminders-app:latest

            echo "Stopping old container if exists..."
            docker rm -f catty-reminders-app || true

            echo "Starting new container..."
            docker run -d \
              --name catty-reminders-app \
              -p 8181:8181 \
              ghcr.io/${GITHUB_REPOSITORY_OWNER}/catty-reminders-app:latest

            echo "Waiting for app to start..."
            sleep 5

            echo "Checking app health..."
            curl -s http://127.0.0.1:8181/docs > /dev/null

            echo "Deployment via Docker container finished successfully."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
